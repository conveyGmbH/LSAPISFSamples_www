<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LS_FieldMappings Cleanup Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }

        .warning strong {
            display: block;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #0c5460;
        }

        .credentials {
            margin: 20px 0;
        }

        .credentials label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .credentials input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-fetch {
            background: #17a2b8;
            color: white;
        }

        .btn-fetch:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-delete:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
        }

        .record {
            background: white;
            border-left: 4px solid #667eea;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .record-id {
            font-weight: 600;
            color: #667eea;
        }

        .record-event {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .log {
            margin-top: 20px;
            padding: 15px;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-success {
            color: #0f0;
        }

        .log-error {
            color: #f00;
        }

        .log-info {
            color: #0ff;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .stat-box {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ LS_FieldMappings Cleanup Tool</h1>

        <div class="warning">
            <strong>‚ö†Ô∏è WARNING: Destructive Operation</strong>
            This tool will DELETE ALL records from LS_FieldMappings table. This action cannot be undone!
        </div>

        <div class="info">
            <strong>‚ÑπÔ∏è What this does:</strong>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Fetches all LS_FieldMappings records</li>
                <li>Displays records to review before deletion</li>
                <li>Deletes each record individually</li>
                <li>Shows real-time progress</li>
            </ul>
        </div>

        <div class="credentials">
            <label for="username">API Username:</label>
            <input type="text" id="username" placeholder="Enter API username" value="apitestappuser">

            <label for="password">API Password:</label>
            <input type="password" id="password" placeholder="Enter API password">

            <label for="apiUrl">API URL:</label>
            <input type="text" id="apiUrl" value="https://lstest.convey.de/apisftest
" readonly>
        </div>

        <div class="button-group">
            <button class="btn-fetch" onclick="fetchRecords()">üì• Fetch Records</button>
            <button class="btn-delete" id="deleteBtn" onclick="deleteAllRecords()" disabled>üóëÔ∏è Delete All Records</button>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-box">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="deletedCount">0</div>
                <div class="stat-label">Deleted</div>
            </div>
            <div class="stat-box">
                <div class="stat-number" id="failedCount">0</div>
                <div class="stat-label">Failed</div>
            </div>
        </div>

        <div id="results" class="results" style="display: none;"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        let records = [];
        let credentials = '';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';

            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStats(total, deleted, failed) {
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('totalCount').textContent = total;
            document.getElementById('deletedCount').textContent = deleted;
            document.getElementById('failedCount').textContent = failed;
        }

        async function fetchRecords() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const apiUrl = document.getElementById('apiUrl').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            credentials = btoa(`${username}:${password}`);

            log('Fetching records from LS_FieldMappings...', 'info');

            try {
                const response = await fetch(`${apiUrl}/LS_FieldMappings?$format=json`, {
                    headers: {
                        'Authorization': `Basic ${credentials}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                records = data.d.results;

                log(`‚úÖ Fetched ${records.length} records`, 'success');
                displayRecords(records);
                updateStats(records.length, 0, 0);

                document.getElementById('deleteBtn').disabled = records.length === 0;

            } catch (error) {
                log(`‚ùå Error fetching records: ${error.message}`, 'error');
                alert(`Failed to fetch records: ${error.message}`);
            }
        }

        function displayRecords(records) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            if (records.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #666;">No records found</p>';
                return;
            }

            records.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'record';
                recordDiv.innerHTML = `
                    <div class="record-id">ID: ${record.FieldMappingsViewId}</div>
                    <div class="record-event">EventId: ${record.EventId}</div>
                    <div class="record-event">Endpoint: ${record.ApiEndpoint}</div>
                `;
                resultsDiv.appendChild(recordDiv);
            });
        }

        async function deleteAllRecords() {
            if (!confirm(`‚ö†Ô∏è Are you ABSOLUTELY SURE you want to delete ALL ${records.length} records?\n\nThis action CANNOT be undone!`)) {
                return;
            }

            if (!confirm('This is your last warning. Click OK to proceed with deletion.')) {
                return;
            }

            const apiUrl = document.getElementById('apiUrl').value;
            const deleteBtn = document.getElementById('deleteBtn');
            const fetchBtn = document.querySelector('.btn-fetch');

            deleteBtn.disabled = true;
            fetchBtn.disabled = true;

            let deleted = 0;
            let failed = 0;

            log(`üóëÔ∏è Starting deletion of ${records.length} records...`, 'info');

            for (let i = 0; i < records.length; i++) {
                const record = records[i];
                const recordId = record.FieldMappingsViewId;

                try {
                    const deleteUrl = `${apiUrl}/LS_FieldMappings(${recordId})`;

                    const response = await fetch(deleteUrl, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Basic ${credentials}`,
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok || response.status === 204) {
                        deleted++;
                        log(`‚úÖ Deleted record ${recordId} (${deleted}/${records.length})`, 'success');
                    } else {
                        failed++;
                        log(`‚ùå Failed to delete record ${recordId}: HTTP ${response.status}`, 'error');
                    }

                    updateStats(records.length, deleted, failed);

                    // Small delay to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));

                } catch (error) {
                    failed++;
                    log(`‚ùå Error deleting record ${recordId}: ${error.message}`, 'error');
                    updateStats(records.length, deleted, failed);
                }
            }

            log(`\nüéâ Cleanup complete!`, 'success');
            log(`   Total: ${records.length}`, 'info');
            log(`   Deleted: ${deleted}`, 'success');
            log(`   Failed: ${failed}`, failed > 0 ? 'error' : 'info');

            deleteBtn.disabled = true;
            fetchBtn.disabled = false;

            // Clear records list
            records = [];
            document.getElementById('results').innerHTML = '<p style="text-align: center; color: #0f0; font-weight: 600;">‚úÖ All records deleted!</p>';
        }
    </script>
</body>
</html>
